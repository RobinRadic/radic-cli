<!DOCTYPE html>

<html>
<head>
  <title>objects.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="ps1.html">
                ps1.js
              </a>
            
              
              <a class="source" href="version.html">
                version.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="command-helper.html">
                command-helper.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="objects.html">
                objects.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>objects.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Yaml = <span class="hljs-literal">null</span>,    <span class="hljs-comment">// External libraries are lazy-loaded</span>
    VisionmediaYaml = <span class="hljs-literal">null</span>,  <span class="hljs-comment">// only if these file types exist.</span>
    Coffee = <span class="hljs-literal">null</span>,
    CSON = <span class="hljs-literal">null</span>,
    PPARSER = <span class="hljs-literal">null</span>,
    Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>),
    FileSystem = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Static members</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> DEFAULT_CLONE_DEPTH = <span class="hljs-number">20</span>,
    NODE_CONFIG, CONFIG_DIR, RUNTIME_JSON_FILENAME, NODE_ENV, APP_INSTANCE,
    HOST, HOSTNAME, ALLOW_CONFIG_MUTATIONS,
    env = {},
    privateUtil = {},
    deprecationWarnings = {},
    configSources = [],          <span class="hljs-comment">// Configuration sources - array of {name, original, parsed}</span>
    checkMutability = <span class="hljs-literal">true</span>;      <span class="hljs-comment">// Check for mutability/immutability on first get</span>


<span class="hljs-keyword">var</span> objects = <span class="hljs-built_in">module</span>.exports;

<span class="hljs-comment">/**
 * &lt;p&gt;Monitor a javascript property for runtime changes.&lt;/p&gt;
 *
 * &lt;p&gt;
 * This method was built for an earlier version of node-config that allowed
 * configuration value mutations.  Since version 1.0.0, node-config no longer
 * allows configuration mutations, and is no longer used in node-config.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * It is deprecated, and will be removed in the next semver incompatible release 2.0.0.
 * &lt;/p&gt;
 *
 * @method watch
 * @deprecated
 * @param object {object} - The object to watch.
 * @param property {string} - The property name to watch.  Watch all object properties if null.
 * @param handler {function(object, propertyName, priorValue, newValue)} - Handler called when a property change is detected.
 *   The handler is run along with other handlers registered for notification.
 *   If your handler changes the value of the property, that change is applied after all handlers have finished processing the current change.
 *   Then all handlers (including this one) will be called again with the newly changed value.
 * @param depth {integer} (optional) - If watching all object properties or if the specified property is an object, this specifies the depth of the object graph to watch for changes.  Default 6.
 * @return object {object} - The original object is returned - for chaining.
 */</span>
objects.watch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object, property, handler, depth)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Initialize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>, o = object;
    <span class="hljs-keyword">var</span> allProperties = property ? [property] : <span class="hljs-built_in">Object</span>.keys(o);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Deprecation warning</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!deprecationWarnings.watch)
    {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'WARNING: config.'</span> + fnName + <span class="hljs-string">'() is deprecated, and will not be supported in release 2.0.'</span>);
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'WARNING: See https://github.com/lorenwest/node-config/wiki/Future-Compatibility#upcoming-incompatibilities'</span>);
        deprecationWarnings.watch = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Depth detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    depth = (depth === <span class="hljs-literal">null</span> ? DEFAULT_CLONE_DEPTH : depth);
    <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create hidden properties on the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!o.__watchers)
    {
        objects.makeHidden(o, <span class="hljs-string">'__watchers'</span>, {});
    }
    <span class="hljs-keyword">if</span> (!o.__propertyValues)
    {
        objects.makeHidden(o, <span class="hljs-string">'__propertyValues'</span>, {});
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Attach watchers to all requested properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    allProperties.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop)</span>
    </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Setup the property for watching (first time only)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(o.__propertyValues[prop]) == <span class="hljs-string">'undefined'</span>)
        {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Don’t error re-defining the property if immutable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> descriptor = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(o, prop);
            <span class="hljs-keyword">if</span> (descriptor &amp;&amp; descriptor.writable === <span class="hljs-literal">false</span>)
            {
                <span class="hljs-keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Copy the value to the hidden field, and add the property to watchers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            o.__propertyValues[prop] = [o[prop]];
            o.__watchers[prop] = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Attach the property watcher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">Object</span>.defineProperty(o, prop, {
                enumerable: <span class="hljs-literal">true</span>,

                get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span>
                </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If more than 1 item is in the values array,
then we’re currently processing watchers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (o.__propertyValues[prop].length == <span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Current value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    {
                        <span class="hljs-keyword">return</span> o.__propertyValues[prop][<span class="hljs-number">0</span>];
                    } <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>[0] is prior value, [1] is new value being processed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    {
                        <span class="hljs-keyword">return</span> o.__propertyValues[prop][<span class="hljs-number">1</span>];
                    }
                },

                set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newValue)</span>
                </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return early if no change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> origValue = o[prop];
                    <span class="hljs-keyword">if</span> (objects.equalsDeep(origValue, newValue))
                    {
                        <span class="hljs-keyword">return</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Remember the new value, and return if we’re in another setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    o.__propertyValues[prop].push(newValue);
                    <span class="hljs-keyword">if</span> (o.__propertyValues[prop].length &gt; <span class="hljs-number">2</span>)
                    {
                        <span class="hljs-keyword">return</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Call all watchers for each change requested</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> numIterations = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">while</span> (o.__propertyValues[prop].length &gt; <span class="hljs-number">1</span>)
                    {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Detect recursion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (++numIterations &gt; <span class="hljs-number">20</span>)
                        {
                            o.__propertyValues[prop] = [origValue];
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Recursion detected while setting ['</span> + prop + <span class="hljs-string">']'</span>);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Call each watcher for the current values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> oldValue = o.__propertyValues[prop][<span class="hljs-number">0</span>];
                        newValue = o.__propertyValues[prop][<span class="hljs-number">1</span>];
                        o.__watchers[prop].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(watcher)</span>
                        </span>{
                            <span class="hljs-keyword">try</span>
                            {
                                watcher(o, prop, oldValue, newValue);
                            } <span class="hljs-keyword">catch</span> (e)
                            {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Log an error and continue with subsequent watchers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Exception in object watcher for "</span> + prop, e);
                            }
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Done processing this value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        o.__propertyValues[prop].splice(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
                    }
                }
            });

        } <span class="hljs-comment">// Done setting up the property for watching (first time)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Add the watcher to the property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        o.__watchers[prop].push(handler);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Recurs if this is an object…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (o[prop] &amp;&amp; <span class="hljs-keyword">typeof</span>(o[prop]) == <span class="hljs-string">'object'</span>)
        {
            objects.watch(o[prop], <span class="hljs-literal">null</span>, handler, depth - <span class="hljs-number">1</span>);
        }

    }); <span class="hljs-comment">// Done processing each property</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return the original object - for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> o;
};

<span class="hljs-comment">/**
 * Attach the Config class prototype to all config objects recursively.
 *
 * &lt;p&gt;
 * This allows you to do anything with CONFIG sub-objects as you can do with
 * the top-level CONFIG object.  It's so you can do this:
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 *   var CUST_CONFIG = require('config').Customer;
 *   CUST_CONFIG.get(...)
 * &lt;/pre&gt;
 *
 * @protected
 * @method attachProtoDeep
 * @param toObject
 * @param depth
 * @return toObject
 */</span>
objects.attachProtoDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(toObject, depth)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Recursion detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>;
    depth = (depth === <span class="hljs-literal">null</span> ? DEFAULT_CLONE_DEPTH : depth);
    <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span> toObject;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Adding Config.prototype methods directly to toObject as hidden properties
because adding to toObject.<strong>proto</strong> exposes the function in toObject</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> fnName <span class="hljs-keyword">in</span> Config.prototype)
    {
        <span class="hljs-keyword">if</span> (!toObject[fnName])
        {
            objects.makeHidden(toObject, fnName, Config.prototype[fnName]);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Add prototypes to sub-objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> toObject)
    {
        <span class="hljs-keyword">if</span> (objects.isObject(toObject[prop]))
        {
            objects.attachProtoDeep(toObject[prop], depth - <span class="hljs-number">1</span>);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return the original object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> toObject;
};

<span class="hljs-comment">/**
 * Return a deep copy of the specified object.
 *
 * This returns a new object with all elements copied from the specified
 * object.  Deep copies are made of objects and arrays so you can do anything
 * with the returned object without affecting the input object.
 *
 * @protected
 * @method cloneDeep
 * @param parent {object} The original object to copy from
 * @param [depth=20] {Integer} Maximum depth (default 20)
 * @return {object} A new object with the elements copied from the copyFrom object
 *
 * This method is copied from https://github.com/pvorb/node-clone/blob/17eea36140d61d97a9954c53417d0e04a00525d9/clone.js
 *
 * Copyright © 2011-2014 Paul Vorbach and contributors.
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions: The above copyright notice and this permission
 * notice shall be included in all copies or substantial portions of the Software.
 */</span>
objects.cloneDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneDeep</span><span class="hljs-params">(parent, depth, circular, prototype)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>maintain two arrays for circular references, where corresponding parents
and children have the same index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> allParents = [];
    <span class="hljs-keyword">var</span> allChildren = [];

    <span class="hljs-keyword">var</span> useBuffer = <span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> circular == <span class="hljs-string">'undefined'</span>)
    {
        circular = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> depth == <span class="hljs-string">'undefined'</span>)
    {
        depth = <span class="hljs-number">20</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>recurse this function so we don’t reset allParents and allChildren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_clone</span><span class="hljs-params">(parent, depth)</span>
    </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>cloning null always returns null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (parent === <span class="hljs-literal">null</span>)
        {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">if</span> (depth == <span class="hljs-number">0</span>)
        {
            <span class="hljs-keyword">return</span> parent;
        }

        <span class="hljs-keyword">var</span> child;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parent != <span class="hljs-string">'object'</span>)
        {
            <span class="hljs-keyword">return</span> parent;
        }

        <span class="hljs-keyword">if</span> (Utils.isArray(parent))
        {
            child = [];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Utils.isRegExp(parent))
        {
            child = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(parent.source, objects.getRegExpFlags(parent));
            <span class="hljs-keyword">if</span> (parent.lastIndex) child.lastIndex = parent.lastIndex;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Utils.isDate(parent))
        {
            child = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(parent.getTime());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (useBuffer &amp;&amp; Buffer.isBuffer(parent))
        {
            child = <span class="hljs-keyword">new</span> Buffer(parent.length);
            parent.copy(child);
            <span class="hljs-keyword">return</span> child;
        } <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> prototype == <span class="hljs-string">'undefined'</span>)
            {
                child = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.getPrototypeOf(parent));
            } <span class="hljs-keyword">else</span>
            {
                child = <span class="hljs-built_in">Object</span>.create(prototype);
            }
        }

        <span class="hljs-keyword">if</span> (circular)
        {
            <span class="hljs-keyword">var</span> index = allParents.indexOf(parent);

            <span class="hljs-keyword">if</span> (index != -<span class="hljs-number">1</span>)
            {
                <span class="hljs-keyword">return</span> allChildren[index];
            }
            allParents.push(parent);
            allChildren.push(child);
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> parent)
        {
            child[i] = _clone(parent[i], depth - <span class="hljs-number">1</span>);
        }

        <span class="hljs-keyword">return</span> child;
    }

    <span class="hljs-keyword">return</span> _clone(parent, depth);
};

<span class="hljs-comment">/**
 * Set objects given a path as a string list
 *
 * @protected
 * @method setPath
 * @param object {object} - Object to set the property on
 * @param path {array[string]} - Array path to the property
 * @param value {mixed} - value to set, ignoring null
 */</span>
objects.setPath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object, path, value)</span>
</span>{
    <span class="hljs-keyword">var</span> nextKey = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span> || path.length === <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.length === <span class="hljs-number">1</span>)
    { <span class="hljs-comment">// no more keys to make, so set the value</span>
        object[path.shift()] = value;
    }
    <span class="hljs-keyword">else</span>
    {
        nextKey = path.shift();
        <span class="hljs-keyword">if</span> (!object.hasOwnProperty(nextKey))
        {
            object[nextKey] = {};
        }
        objects.setPath(object[nextKey], path, value);
    }
};

<span class="hljs-comment">/**
 * Create a new object patterned after substitutionMap, where:
 * 1. Terminal string values in substitutionMap are used as keys
 * 2. To look up values in a key-value store, variables
 * 3. And parent keys are created as necessary to retain the structure of substitutionMap.
 *
 * @protected
 * @method substituteDeep
 * @param substitionMap {object} - an object whose terminal (non-subobject) values are strings
 * @param variables {object[string:value]} - usually process.env, a flat object used to transform
 *      terminal values in a copy of substititionMap.
 * @returns {object} - deep copy of substitutionMap with only those paths whose terminal values
 *      corresponded to a key in `variables`
 */</span>
objects.substituteDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(substitutionMap, variables)</span>
</span>{
    <span class="hljs-keyword">var</span> result = {};

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_substituteVars</span><span class="hljs-params">(map, vars, pathTo)</span>
    </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> map)
        {
            <span class="hljs-keyword">var</span> value = map[prop];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(value) === <span class="hljs-string">'string'</span>)
            { <span class="hljs-comment">// We found a leaf variable name</span>
                <span class="hljs-keyword">if</span> (vars[value])
                { <span class="hljs-comment">// if the vars provide a value set the value in the result map</span>
                    objects.setPath(result, pathTo.concat(prop), vars[value]);
                }
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objects.isObject(value))
            { <span class="hljs-comment">// work on the subtree, giving it a clone of the pathTo</span>
                _substituteVars(value, vars, pathTo.concat(prop));
            }
            <span class="hljs-keyword">else</span>
            {
                msg = <span class="hljs-string">"Illegal key type for substitution map at "</span> + pathTo.join(<span class="hljs-string">'.'</span>) + <span class="hljs-string">': '</span> + <span class="hljs-keyword">typeof</span>(value);
                <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(msg);
            }
        }
    }

    _substituteVars(substitutionMap, variables, []);
    <span class="hljs-keyword">return</span> result;

};

<span class="hljs-comment">/**
 * Return true if two objects have equal contents.
 *
 * @protected
 * @method equalsDeep
 * @param object1 {object} The object to compare from
 * @param object2 {object} The object to compare with
 * @param depth {integer} An optional depth to prevent recursion.  Default: 20.
 * @return {boolean} True if both objects have equivalent contents
 */</span>
objects.equalsDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object1, object2, depth)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Recursion detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>;
    depth = (depth === <span class="hljs-literal">null</span> ? DEFAULT_CLONE_DEPTH : depth);
    <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span> {};
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Fast comparisons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!object1 || !object2)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">if</span> (object1 === object2)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(object1) != <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span>(object2) != <span class="hljs-string">'object'</span>)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>They must have the same keys.  If their length isn’t the same
then they’re not equal.  If the keys aren’t the same, the value
comparisons will fail.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(object1).length != <span class="hljs-built_in">Object</span>.keys(object2).length)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Compare the values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> object1)
    {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Call recursively if an object or array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (object1[prop] &amp;&amp; <span class="hljs-keyword">typeof</span>(object1[prop]) === <span class="hljs-string">'object'</span>)
        {
            <span class="hljs-keyword">if</span> (!objects.equalsDeep(object1[prop], object2[prop], depth - <span class="hljs-number">1</span>))
            {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">if</span> (object1[prop] !== object2[prop])
            {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Test passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

<span class="hljs-comment">/**
 * Returns an object containing all elements that differ between two objects.
 * &lt;p&gt;
 * This method was designed to be used to create the runtime.json file
 * contents, but can be used to get the diffs between any two Javascript objects.
 * &lt;/p&gt;
 * &lt;p&gt;
 * It works best when object2 originated by deep copying object1, then
 * changes were made to object2, and you want an object that would give you
 * the changes made to object1 which resulted in object2.
 * &lt;/p&gt;
 *
 * @protected
 * @method diffDeep
 * @param object1 {object} The base object to compare to
 * @param object2 {object} The object to compare with
 * @param depth {integer} An optional depth to prevent recursion.  Default: 20.
 * @return {object} A differential object, which if extended onto object1 would
 *                  result in object2.
 */</span>
objects.diffDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object1, object2, depth)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Recursion detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>, diff = {};
    depth = (depth === <span class="hljs-literal">null</span> ? DEFAULT_CLONE_DEPTH : depth);
    <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span> {};
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Process each element from object2, adding any element that’s different
from object 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> parm <span class="hljs-keyword">in</span> object2)
    {
        <span class="hljs-keyword">var</span> value1 = object1[parm];
        <span class="hljs-keyword">var</span> value2 = object2[parm];
        <span class="hljs-keyword">if</span> (value1 &amp;&amp; value2 &amp;&amp; objects.isObject(value2))
        {
            <span class="hljs-keyword">if</span> (!(objects.equalsDeep(value1, value2)))
            {
                diff[parm] = objects.diffDeep(value1, value2, depth - <span class="hljs-number">1</span>);
            }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(value1) &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(value2))
        {
            <span class="hljs-keyword">if</span> (!objects.equalsDeep(value1, value2))
            {
                diff[parm] = value2;
            }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value1 !== value2)
        {
            diff[parm] = value2;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Return the diff object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> diff;

};

<span class="hljs-comment">/**
 * Extend an object, and any object it contains.
 *
 * This does not replace deep objects, but dives into them
 * replacing individual elements instead.
 *
 * @protected
 * @method extendDeep
 * @param mergeInto {object} The object to merge into
 * @param mergeFrom... {object...} - Any number of objects to merge from
 * @param depth {integer} An optional depth to prevent recursion.  Default: 20.
 * @return {object} The altered mergeInto object is returned
 */</span>
objects.extendDeep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(mergeInto)</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Initialize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> depth = vargs.pop();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(depth) != <span class="hljs-string">'number'</span>)
    {
        vargs.push(depth);
        depth = DEFAULT_CLONE_DEPTH;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Recursion detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span> mergeInto;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Cycle through each object to extend</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    vargs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(mergeFrom)</span>
    </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Cycle through each element of the object to merge from</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> mergeFrom)
        {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Extend recursively if both elements are objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (objects.isObject(mergeInto[prop]) &amp;&amp; objects.isObject(mergeFrom[prop]))
            {
                objects.extendDeep(mergeInto[prop], mergeFrom[prop], depth - <span class="hljs-number">1</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Copy recursively if the mergeFrom element is an object (or array or fn)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mergeFrom[prop] &amp;&amp; <span class="hljs-keyword">typeof</span> mergeFrom[prop] == <span class="hljs-string">'object'</span>)
            {
                mergeInto[prop] = objects.cloneDeep(mergeFrom[prop], depth - <span class="hljs-number">1</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Simple assignment otherwise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span>
            {
                mergeInto[prop] = mergeFrom[prop];
            }
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> mergeInto;

};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
